--- Parser/pgenmain.c
+++ Parser/pgenmain.c
@@ -38,12 +38,13 @@
 }
 
 #ifdef WITH_THREAD
-/* Functions needed by obmalloc.c */
+/* Needed by obmalloc.c */
 int PyGILState_Check(void)
 { return 1; }
+#endif
+
 void _PyMem_DumpTraceback(int fd, const void *ptr)
 {}
-#endif
 
 int
 main(int argc, char **argv)
--- Python/pylifecycle.c
+++ Python/pylifecycle.c
@@ -748,7 +748,9 @@
 
     /* Issue #10915, #15751: The GIL API doesn't work with multiple
        interpreters: disable PyGILState_Check(). */
+#if WITH_THREAD
     _PyGILState_check_enabled = 0;
+#endif
 
     interp = PyInterpreterState_New();
     if (interp == NULL)
--- Python/traceback.c
+++ Python/traceback.c
@@ -745,7 +745,7 @@
     if (current_tstate == NULL) {
         /* Call _PyThreadState_UncheckedGet() instead of PyThreadState_Get()
            to not fail with a fatal error if the thread state is NULL. */
-        current_thread = _PyThreadState_UncheckedGet();
+        current_tstate = _PyThreadState_UncheckedGet();
     }
 
     if (interp == NULL) {
